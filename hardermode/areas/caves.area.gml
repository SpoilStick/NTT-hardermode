global.sprCrystalPropBlueDead = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAAGAAAAAYCAYAAAAF6fiUAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAACpUlEQVRo3u2Yv2sUQRTHv2+THFxSmEAMmivuuiAKEfLDIkQ4G7sNWIgEDJLCzjKksUxz+B9YBEkghYXo/gE5iFwhhxhBEK1yRUxARW08MOeNRTLD7N7uMrf7Lrsx+7pZlveG72ff+84OCSGQRXJBGYAMQAagixAAKJMtGQD6i6cJgQt6Kj8eUwB+L1FKhf7vOiDshWwc9RiASXtQSr/4M9FRSQEQKeiiVABKcwecC09IEkCY4GnokHMHgL0DiKhj/0IItv1y5E8MgN/muUUiInHz9W+1rjvv0Hwyx1aDiMRle1mtvza+o/X+VVf5gwB083tMHOL0QiQiEnvtX1iqDfjW4Mi/+PABqoeW67kEYZI/UQB+4nCKREQiv1LDx8o1AHDV2pkfZAHQP7mAuzdGAMAF4sBZPzUAkSCEicMlEhGJnL0GAOibKKtaAFCyLrAAsIozAABreFyBAICtp88iA4h6PUpc4nCJpNeQdZrblePFWyf2mNMBSAit/d3jxbeGUX4vgLh30xRHHBkcIimTn7LVs/ytVTS3K9irb2KpNhBrzKn8o0X1rL9wHa39XSzeKaN6aBl5QSIAgsTRAcQRyWvwG3NHKM3cVwByhVl8fvlIjb2d+cHuTi6e00/5UhtbL6oKgDU0hnu3rypPOHDWA/NzjiAjAGHi6ACiiiTNXY8rqx/UyQpTNnKFWQDoyG80s09OPno8f/NDHT8xWoQ1NAYAHRASBxAmjtwcEQmvSNKkTUTyeouCelJDz697j6nfeI1Xhhw1RCQkBN2Yg0yZ6xRk/PXn7DWXMH8/VfHHeezanD6iJIi+ibLRKPID4FtjekFICDqgKADaP7+g3ai7818sCQlBBxTnT5jt7zS/UgsUhquGBN2LGhKCNTzuKz7nVUQWPY5/r8v74M+K7RMAAAAASUVORK5CYII=",4,12,12)
global.sprCrystalPropGreenDead = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAAGAAAAAYCAYAAAAF6fiUAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAACkklEQVRo3u2YsW/TUBDGv7NU1MEVGTpGkUU7ZCoZu8CAEEKIkaFJF4ao7IWh/AUwADsRAwuBoWOFqgp1KAtjBEsXKivyiFCgGVCRfAyxH7ZjWy/2pTbUN/lZ1t3T9/Pd92xiZlRRXFAFoAJQAZghGABVshUDIPjgeUKQgl7Kl0cXQNxDVFKh/7sOSHugGkdzBqDTHlTSN/6f6KiiAHAJuqgUgMrcARfCE4oEkCZ4GTrkwgEQ7wAimto/M4vtVyJ/YQDiNi8tEhFxbfhGrX8ef4F766lYDSLiS50bav179B38fjBT/iQAs3wek4Q48xCJiNh2f6Dl7MXWkMjf2bqP3fEwdN8HoZO/UABx4kiKRERsHOzg5OZjAAjVGjU2RQDQnRba9RYAhECc9Q/PDUAmCGniSIlERGz0upOFtaxqAYBlXJYBcL05WZiLCgQA9HuvMwPI+nuUpMSREilUw6vj7tuT6xfvco+5EAAPAjunk+vPX7XyRwHk/TdNecTxQ0IkZfLbG+qecduCu2/DfvYSLWcv15hT+ddW/t6rL4GdU3TWr2F3PNTygkIAJIkTBJBHpKjBD+p3YT16oAAYTRMn3edq7I0am7OdXCKnn3tmA/1PHxUAqi2g3VxXnnDWP0zMLzmCtACkiRMEkFUk39yDceXDE3WywvYGjKYJAFP5tWa2d/IJxltnoI6fWFsB1RYAYApC4QDSxPE3R0QcFck3aR2Rot6ioHo1QvkD3qPrN1HjVaJ5o4aIWEEIGHOSKUudgrTffqPXDQkD+xvcrVehzQVHlA8C1rLWKIoFEFfjYZt9CEFAmQCMf4GPjsP5r66yDyEIKM+XsNjXqXGwkyiMWA0f9BxqKAjmYqz4kr8iqphz/AFhRQHvZYWcNQAAAABJRU5ErkJggg==",4,12,12)
global.skycrystal = sprite_add_base64("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",1,126,0)
#define area_name
return "4-"+string(GameCont.subarea);

#define area_sprite(q)
switch (q) {
    case sprFloor1: return sprFloor4;
    case sprFloor1B: return sprFloor4B;
    case sprFloor1Explo: return sprFloor4Explo;
    case sprWall1Trans: return sprWall4Trans;
    case sprWall1Bot: return sprWall4Bot;
    case sprWall1Out: return sprWall4Out;
    case sprWall1Top: return sprWall4Top;
    case sprDebris1: return sprDebris4;
	case sprDetail1: return sprDetail4;
}

#define area_transit
if (lastarea != "caves" && lastarea == "bigdog") {
    if Player.curse >= 1 || Player.bcurse >= 1
		area = "cavesinv"
	else
		area = "caves";
}
    

#define area_finish
if subarea < 3{
	area = "caves";
	subarea += 1;
	}
else{
	area = "city";
	subarea = 1;
	}
#define area_setup
sound_play_music(mus4)
sound_play_ambient(amb4);
goal = 145;
background_color = make_color_rgb(129,82,188);
BackCont.shadcol = 786950;
TopCont.darkness = 1;

#define area_make_floor
instance_create(x, y, Floor)
var turn = choose(0,0,0,0,90,-90,180)
direction += turn;
if (turn == 180 && point_distance(x, y, 10016, 10016) > 48) {
    // turnarounds - weapon chests spawn in such
    instance_create(x, y, Floor);
    with instance_create(x + 16, y + 16, WeaponChest){
		curse = 1
		sprite_index = sprCursedChest
		}
}
if (random(19 + instance_number(FloorMaker)) > 22) {
    // dead ends - ammo chests spawn in such
    if (point_distance(x, y, 10016, 10016) > 48) {
        instance_create(x + 16, y + 16, AmmoChest);
        instance_create(x, y, Floor);
    }
    instance_destroy();
} else if (random(4) < 1) {
    // branching
    instance_create(x, y, FloorMaker);
}
#define area_start
with Floor if random(12)<1
	with instance_create(x,y,TopDecalCave)
		dir = choose(-1,1) 
with Wall if random(16)<1{ 
	if place_meeting(x+16,y,Floor)
		with instance_create(x+16,y,Bones){
			sprite_index = sprCaveDecal
			image_xscale = 1
			}
	else if place_meeting(x-16,y,Floor)
		with instance_create(x,y,Bones){
			sprite_index = sprCaveDecal
			image_xscale = -1
			}
	}
if GameCont.subarea==3{ //hypercrystal
	with instance_furthest(10016, 10016, Floor){
		instance_create(x+16,y+16,HyperCrystal)
		if (skill_get(18)) with instance_nearest(x,y,Floor){
			mod_script_call("mod", "props", "cave_create",x+16+lengthdir_x(64,point_direction(Player.x,Player.y,x,y)),y+16+lengthdir_y(64,point_direction(Player.x,Player.y,x,y)))
			}
		}
	}
else{
var fla = 0
with Player
	if string_count("FLAME",weapon_get_name(wep)) > 0 || string_count("FLAME",weapon_get_name(bwep)) > 0 || string_count("FLARE",weapon_get_name(wep)) > 0 || string_count("FLARE",weapon_get_name(bwep)) > 0 || string_count("DRAGON",weapon_get_name(wep)) > 0 || string_count("DRAGON",weapon_get_name(bwep)) > 0 || string_count("INCIN",weapon_get_name(wep)) > 0 || string_count("INCIN",weapon_get_name(bwep)) > 0
	fla += 1
if random(7)<1 fla += 1
if fla > 0 and instance_exists(Bones) with instance_furthest(Player.x, Player.y, Bones){ // icecaves entrance
	mod_script_call("mod", "props", "cave_create",x,y)
	instance_destroy()
	}
}	
	
with Floor if styleb = 1{ // slow floor
	traction = 2
	}
with Floor if random(100)<1
	with instance_create(x,y-game_height/2,Effect){
		sprite_index = global.skycrystal
		name = "skycrystal"
		//trace("hi")
		depth = -12
		image_alpha = 0
		}
		
 
		
#define area_pop_enemies
if (random(24) < 1) mod_script_call("mod", "enemies", "crystalshielder_create", x + 16, y + 16);
if (random(24) < 1) mod_script_call("mod", "enemies", "EliteSpider_create", x + 16, y + 16);
if (random(3*GameCont.subarea) < 2) instance_create(x + 16, y + 16, Spider);
with instance_create(x + 16, y + 16, LaserCrystal) sleep = 1
if (random(35) < 1) instance_create(x + 16, y + 16, LightningCrystal) sleep = 1
if (random(40) < 1) mod_script_call("mod", "enemies", "plasmacrystal_create", x + 16, y + 16);
if (random(8*GameCont.subarea) < 1) mod_script_call("mod", "enemies", "bigcrystal_create", x + 16, y + 16);
if GameCont.subarea > 1{
if (random(18) < 1) with instance_create(x + 16, y + 16, LightningCrystal) sleep = 1
if (random(24) < 1) mod_script_call("mod", "enemies", "bigcrystal_create", x + 16, y + 16);
}else{
if (random(9) < 4) instance_create(x + random_range(10,20), y + random_range(10,20), Cocoon);
if (random(24) < 1) mod_script_call("mod", "enemies", "SpiderPit_create", x + 16, y + 16);
}
#define area_pop_props
if (random(4) < 1)with instance_create(x + 16, y + 16, CrystalProp){
	if (random(2)<1){
		spr_idle = sprCrystalProp
		spr_hurt = sprCrystalPropHurt
		spr_dead = sprCrystalPropDead
		}
	else if (random(2)<1){
		spr_idle = sprCrystalPropBlue
		spr_hurt = sprCrystalPropBlueHurt
		spr_dead = global.sprCrystalPropBlueDead
		}
	else{
		spr_idle = sprCrystalPropGreen
		spr_hurt = sprCrystalPropGreenHurt
		spr_dead = global.sprCrystalPropGreenDead
		}
	}
if GameCont.subarea == 1 if random(16)<1 instance_create(x + 16, y + 16, BonePile);

#define area_mapdata(lx, ly, lp, ls, ws, ll)
if argument2 = "junkyard"
return [lx+18, 0];
else 
return[lx, 0];